<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Authentication Callback</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .callback-card {
      background: rgba(255, 255, 255, 0.1);
      -webkit-backdrop-filter: blur(10px);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 3rem;
      text-align: center;
      color: white;
      max-width: 400px;
      width: 100%;
    }
    .spinner {
      width: 3rem;
      height: 3rem;
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-top: 4px solid white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 1rem;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .error-icon {
      font-size: 3rem;
      color: #ff6b6b;
      margin-bottom: 1rem;
    }
    .success-icon {
      font-size: 3rem;
      color: #51cf66;
      margin-bottom: 1rem;
    }
    .hidden-state {
      display: none;
    }
    .progress-bar-initial {
      width: 0%;
    }
  </style>
</head>
<body>
  <div class="callback-card">
    <div id="loading-state">
      <div class="spinner"></div>
      <h4>Processing authentication...</h4>
      <p class="mb-0">Please wait while we complete your login.</p>
    </div>
    
    <div id="success-state" class="hidden-state">
      <div class="success-icon">
        <i class="fa fa-check-circle"></i>
      </div>
      <h4>Authentication Successful!</h4>
      <p class="mb-3">Redirecting you to the application...</p>
      <div class="progress">
        <div class="progress-bar progress-bar-striped progress-bar-animated progress-bar-initial"></div>
      </div>
    </div>
    
    <div id="error-state" class="hidden-state">
      <div class="error-icon">
        <i class="fa fa-exclamation-circle"></i>
      </div>
      <h4>Authentication Failed</h4>
      <p id="error-message" class="mb-3">An error occurred during authentication.</p>
      <button class="btn btn-outline-light" onclick="redirectToSignIn()">
        <i class="fa fa-arrow-left me-2"></i>Back to Sign In
      </button>
    </div>
  </div>

  <script type="module">
    import { modernAuthController } from '../modules/auth/ModernAuthController.js';

    class AuthCallbackHandler {
      constructor() {
        this.init();
      }

      async init() {
        try {
          // Get URL parameters
          const urlParams = new URLSearchParams(window.location.search);
          const hash = window.location.hash;
          
          // Handle Supabase OAuth callback
          if (hash) {
            await this.handleSupabaseCallback(hash);
          } else if (urlParams.has('code')) {
            await this.handleOAuthCallback(urlParams);
          } else {
            throw new Error('No authentication data found in callback');
          }
        } catch (error) {
          console.error('Auth callback error:', error);
          this.showError(error.message);
        }
      }

      async handleSupabaseCallback(hash) {
        try {
          // Parse Supabase hash parameters
          const hashParams = new URLSearchParams(hash.substring(1));
          const accessToken = hashParams.get('access_token');
          const refreshToken = hashParams.get('refresh_token');
          
          if (!accessToken) {
            throw new Error('No access token found in callback');
          }

          // Extract user information from callback parameters
          const authData = {
            email: hashParams.get('email') || '',
            fullName: hashParams.get('full_name') || hashParams.get('name') || 'User',
            authUid: hashParams.get('sub') || hashParams.get('user_id') || '',
            avatarUrl: hashParams.get('avatar_url') || hashParams.get('picture') || null
          };

          // Validate required data
          if (!authData.email || !authData.authUid) {
            throw new Error('Missing required user data from OAuth callback');
          }

          // Complete authentication with our backend
          const result = await modernAuthController.handleGoogleCallback(authData);
          
          if (result.success) {
            this.showSuccess();
            
            // Send success message to parent window
            setTimeout(() => {
              if (window.opener) {
                window.opener.postMessage({
                  type: 'GOOGLE_AUTH_SUCCESS',
                  user: result.user,
                  token: result.token || 'auth-token'
                }, window.location.origin);
                window.close();
              } else {
                // Fallback: redirect to homepage
                window.location.href = '/src/pages/HomePage.html';
              }
            }, 2000);
          } else {
            throw new Error(result.message);
          }
        } catch (error) {
          throw new Error(`Supabase callback error: ${error.message}`);
        }
      }

      async handleOAuthCallback(urlParams) {
        // Handle other OAuth providers if needed
        const code = urlParams.get('code');
        const state = urlParams.get('state');
        
        // This would be implemented based on your OAuth provider
        throw new Error('OAuth callback not implemented for this provider');
      }

      showSuccess() {
        document.getElementById('loading-state').style.display = 'none';
        document.getElementById('success-state').classList.remove('hidden-state');
        
        // Animate progress bar
        const progressBar = document.querySelector('.progress-bar');
        let width = 0;
        const interval = setInterval(() => {
          width += 2;
          progressBar.style.width = width + '%';
          
          if (width >= 100) {
            clearInterval(interval);
            // Redirect will be handled by the auth controller
          }
        }, 30);
      }

      showError(message) {
        document.getElementById('loading-state').style.display = 'none';
        document.getElementById('error-state').classList.remove('hidden-state');
        document.getElementById('error-message').textContent = message;
        
        // Send error message to parent window
        setTimeout(() => {
          if (window.opener) {
            window.opener.postMessage({
              type: 'GOOGLE_AUTH_ERROR',
              message: message
            }, window.location.origin);
            window.close();
          }
        }, 3000);
      }
    }

    // Global function for error state button
    window.redirectToSignIn = function() {
      window.location.href = '/src/pages/SigninPage.html';
    };

    // Initialize callback handler
    new AuthCallbackHandler();
  </script>
</body>
</html>