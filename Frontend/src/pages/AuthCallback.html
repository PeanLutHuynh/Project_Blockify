<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Authenticating...</title>
  <link rel="icon" href="/public/favicon.ico" />
  
</head>
<body>
  <div class="container py-5">
    <h3>Authenticating with Google...</h3>
    <p id="status" class="text-muted">Please wait while we complete sign-in.</p>
  </div>

  <script type="module">
    import { ENV } from '/src/core/config/env.ts';
    (function () {
      const SUPABASE_URL = ENV.SUPABASE_URL || '';
      const SUPABASE_ANON_KEY = ENV.SUPABASE_ANON_KEY || '';
      const API_BASE_URL = ENV.API_BASE_URL;

      function parseHashParams() {
        const hash = window.location.hash.replace(/^#/, '');
        const params = new URLSearchParams(hash);
        const queryParams = new URLSearchParams(window.location.search);
        const error = queryParams.get('error');
        const errorDesc = queryParams.get('error_description');
        if (error) {
          throw new Error(`Supabase callback error: ${errorDesc || error}`);
        }
        return {
          access_token: params.get('access_token'),
          refresh_token: params.get('refresh_token'),
          token_type: params.get('token_type'),
          expires_in: params.get('expires_in')
        };
      }

      function decodeJwt(token) {
        try {
          const parts = token.split('.');
          if (parts.length !== 3) return null;
          const payload = JSON.parse(atob(parts[1].replace(/-/g, '+').replace(/_/g, '/')));
          return payload;
        } catch (_) {
          return null;
        }
      }

      async function getSupabaseUser(accessToken) {
        const resp = await fetch(`${SUPABASE_URL}/auth/v1/user`, {
          headers: {
            'Authorization': `Bearer ${accessToken}`,
            'apikey': SUPABASE_ANON_KEY
          },
          credentials: 'omit'
        });
        if (!resp.ok) throw new Error('Failed to fetch user from Supabase');
        return resp.json();
      }

      async function completeAuth() {
        const statusEl = document.getElementById('status');
        try {
          const { access_token } = parseHashParams();
          if (!access_token) {
            throw new Error('Supabase callback error: Missing access_token in URL hash');
          }

          if (!SUPABASE_URL || !SUPABASE_ANON_KEY) {
            throw new Error('Supabase configuration missing on client');
          }

          const supaUser = await getSupabaseUser(access_token);
          const email = supaUser?.email || supaUser?.user?.email;
          let authUid = supaUser?.id || supaUser?.user?.id;
          const meta = supaUser?.user_metadata || supaUser?.user?.user_metadata || {};
          const avatarUrl = meta?.avatar_url || '';
          const derivedName = email ? email.split('@')[0] : '';
          const fullName = (meta.full_name || meta.name || derivedName || 'New User');

          if (!authUid) {
            const payload = decodeJwt(access_token);
            if (payload && (payload.sub || payload.user_id)) {
              authUid = payload.sub || payload.user_id;
            }
          }

          if (!email || !authUid) {
            throw new Error('Supabase callback error: Missing required user data from OAuth callback');
          }

          const resp = await fetch(`${API_BASE_URL}/auth/google`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Accept': 'application/json'
            },
            credentials: 'include',
            body: JSON.stringify({ email, fullName, authUid, avatarUrl })
          });

          const json = await resp.json();
          if (!resp.ok || !json?.success) {
            throw new Error(json?.message || 'Google authentication failed');
          }

          // Persist token and user so app can continue seamlessly
          try {
            localStorage.setItem(ENV.JWT_STORAGE_KEY, json.data?.token || json.token);
            localStorage.setItem(ENV.USER_STORAGE_KEY, JSON.stringify(json.data?.user || json.user));
          } catch (_) {}

          // Google OAuth users are already verified by Google, redirect to next page
          const next = sessionStorage.getItem('redirectAfterAuth');
          sessionStorage.removeItem('redirectAfterAuth');
          if (next) {
            window.location.replace(next);
          } else {
            window.location.replace('/src/pages/HomePage.html');
          }
        } catch (err) {
          console.error('Auth callback error:', err);
          if (statusEl) statusEl.textContent = (err && err.message) ? err.message : 'Authentication failed.';
        }
      }

      completeAuth();
    })();
  </script>
</body>
</html>